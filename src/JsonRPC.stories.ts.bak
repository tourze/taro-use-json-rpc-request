import type { Meta, StoryObj } from '@storybook/react';
import React, { useState } from 'react';
import { JsonRPC } from './index';
import { resetStorybookTaro } from './mocks';

const meta: Meta<typeof JsonRPC> = {
  title: 'API/JsonRPC',
  component: JsonRPC,
  tags: ['autodocs'],
  parameters: {
    layout: 'centered',
    docs: {
      description: {
        component: `
JsonRPC ç±»æä¾›äº†å®Œæ•´çš„JSON-RPC 2.0åè®®å®ç°ï¼Œæ”¯æŒï¼š

- ğŸ” JWTè®¤è¯å’ŒHMAC-SHA1ç­¾å
- ğŸ“± Taroç¯å¢ƒé›†æˆ
- ğŸ¯ TypeScriptå®Œå…¨æ”¯æŒ
- ğŸ”„ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- ğŸ“¦ Base64ç¼–ç æ”¯æŒ
        `
      }
    }
  },
};

export default meta;
type Story = StoryObj<typeof meta>;

// åˆå§‹åŒ–é…ç½®ç¤ºä¾‹
export const Configuration: Story = {
  render: () => {
    const [config, setConfig] = useState({
      baseURL: 'https://api.example.com',
      appId: 'demo-app',
      appSecret: 'demo-secret',
      useAuthorization: true,
      timeout: 10000
    });

    const [message, setMessage] = useState('');

    const handleInit = () => {
      try {
        JsonRPC.init(config);
        setMessage('âœ… JsonRPC åˆå§‹åŒ–æˆåŠŸï¼');
      } catch (error: any) {
        setMessage(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
      }
    };

    return (
      <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '8px', maxWidth: '600px' }}>
        <h3>JsonRPC é…ç½®ç¤ºä¾‹</h3>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', marginBottom: '4px', fontWeight: 'bold' }}>
            Base URL:
          </label>
          <input
            type="text"
            value={config.baseURL}
            onChange={(e) => setConfig({ ...config, baseURL: e.target.value })}
            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', marginBottom: '4px', fontWeight: 'bold' }}>
            App ID:
          </label>
          <input
            type="text"
            value={config.appId}
            onChange={(e) => setConfig({ ...config, appId: e.target.value })}
            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', marginBottom: '4px', fontWeight: 'bold' }}>
            App Secret:
          </label>
          <input
            type="password"
            value={config.appSecret}
            onChange={(e) => setConfig({ ...config, appSecret: e.target.value })}
            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }}
          />
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <input
              type="checkbox"
              checked={config.useAuthorization}
              onChange={(e) => setConfig({ ...config, useAuthorization: e.target.checked })}
            />
            ä½¿ç”¨Bearer Tokenæˆæƒ
          </label>
        </div>

        <button
          onClick={handleInit}
          style={{
            padding: '10px 20px',
            background: '#0070f3',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer'
          }}
        >
          ğŸš€ åˆå§‹åŒ– JsonRPC
        </button>

        {message && (
          <div style={{
            marginTop: '16px',
            padding: '12px',
            borderRadius: '4px',
            background: message.includes('âœ…') ? '#e8f5e8' : '#ffebee',
            color: message.includes('âœ…') ? '#2e7d32' : '#c62828'
          }}>
            {message}
          </div>
        )}

        <div style={{ marginTop: '20px', background: '#f5f5f5', padding: '12px', borderRadius: '4px' }}>
          <h4>å½“å‰é…ç½®:</h4>
          <pre style={{ fontSize: '12px', overflow: 'auto' }}>
            {JSON.stringify(config, null, 2)}
          </pre>
        </div>
      </div>
    );
  },
  parameters: {
    docs: {
      description: {
        story: 'å±•ç¤ºå¦‚ä½•åˆå§‹åŒ–å’Œé…ç½®JsonRPCå®¢æˆ·ç«¯ã€‚'
      }
    }
  }
};

// APIè¯·æ±‚æµ‹è¯•å·¥å…·
export const ApiTester: Story = {
  render: () => {
    const [method, setMethod] = useState('user.getProfile');
    const [params, setParams] = useState('{"userId": "123"}');
    const [withJwt, setWithJwt] = useState(true);
    const [customHeaders, setCustomHeaders] = useState('{"Custom-Header": "test-value"}');
    const [result, setResult] = useState<any>(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    const handleRequest = async () => {
      setLoading(true);
      setError('');
      setResult(null);

      try {
        resetStorybookTaro();

        // åˆå§‹åŒ–JsonRPC
        JsonRPC.init({
          baseURL: 'https://mock-api.example.com',
          appId: 'storybook-test',
          appSecret: 'storybook-secret',
          useAuthorization: true
        });

        let parsedParams;
        let parsedHeaders;

        try {
          parsedParams = JSON.parse(params);
        } catch (e) {
          parsedParams = {};
        }

        try {
          parsedHeaders = JSON.parse(customHeaders);
        } catch (e) {
          parsedHeaders = {};
        }

        const response = await JsonRPC.request(method, parsedParams, {
          withJwt,
          headers: parsedHeaders
        });

        setResult(response);
      } catch (err: any) {
        setError(err.message || 'è¯·æ±‚å¤±è´¥');
      } finally {
        setLoading(false);
      }
    };

    return (
      <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '8px', maxWidth: '800px' }}>
        <h3>API è¯·æ±‚æµ‹è¯•å·¥å…·</h3>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', marginBottom: '4px', fontWeight: 'bold' }}>
            æ–¹æ³•å:
          </label>
          <select
            value={method}
            onChange={(e) => setMethod(e.target.value)}
            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }}
          >
            <option value="user.getProfile">user.getProfile</option>
            <option value="user.getFriends">user.getFriends</option>
            <option value="user.updateProfile">user.updateProfile</option>
            <option value="system.getStats">system.getStats</option>
            <option value="nonexistent.method">nonexistent.method (æµ‹è¯•é”™è¯¯)</option>
          </select>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', marginBottom: '4px', fontWeight: 'bold' }}>
            å‚æ•° (JSONæ ¼å¼):
          </label>
          <textarea
            value={params}
            onChange={(e) => setParams(e.target.value)}
            rows={3}
            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', fontFamily: 'monospace' }}
          />
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <input
              type="checkbox"
              checked={withJwt}
              onChange={(e) => setWithJwt(e.target.checked)}
            />
            åŒ…å«JWT Token
          </label>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', marginBottom: '4px', fontWeight: 'bold' }}>
            è‡ªå®šä¹‰è¯·æ±‚å¤´ (JSONæ ¼å¼):
          </label>
          <textarea
            value={customHeaders}
            onChange={(e) => setCustomHeaders(e.target.value)}
            rows={2}
            style={{ width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', fontFamily: 'monospace' }}
          />
        </div>

        <button
          onClick={handleRequest}
          disabled={loading}
          style={{
            padding: '10px 20px',
            background: loading ? '#ccc' : '#28a745',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: loading ? 'not-allowed' : 'pointer',
            marginBottom: '16px'
          }}
        >
          {loading ? 'â³ è¯·æ±‚ä¸­...' : 'ğŸš€ å‘é€è¯·æ±‚'}
        </button>

        {error && (
          <div style={{
            background: '#ffebee',
            color: '#c62828',
            padding: '12px',
            borderRadius: '4px',
            marginBottom: '16px'
          }}>
            <strong>âŒ é”™è¯¯:</strong> {error}
          </div>
        )}

        {result && (
          <div style={{
            background: '#e8f5e8',
            padding: '12px',
            borderRadius: '4px',
            marginBottom: '16px'
          }}>
            <h4>âœ… è¯·æ±‚ç»“æœ:</h4>
            <pre style={{ fontSize: '12px', overflow: 'auto', maxHeight: '300px' }}>
              {JSON.stringify(result, null, 2)}
            </pre>
          </div>
        )}
      </div>
    );
  },
  parameters: {
    docs: {
      description: {
        story: 'ä¸€ä¸ªäº¤äº’å¼çš„APIæµ‹è¯•å·¥å…·ï¼Œå¯ä»¥æµ‹è¯•å„ç§æ–¹æ³•å’Œå‚æ•°ç»„åˆã€‚'
      }
    }
  }
};

// ç­¾åéªŒè¯ç¤ºä¾‹
export const SignatureDemo: Story = {
  render: () => {
    const [showSignature, setShowSignature] = useState(false);
    const [signatureInfo, setSignatureInfo] = useState<any>(null);

    const demonstrateSignature = async () => {
      try {
        resetStorybookTaro();

        // ä½¿ç”¨å¯†é’¥åˆå§‹åŒ–
        JsonRPC.init({
          baseURL: 'https://mock-api.example.com',
          appId: 'demo-app',
          appSecret: 'demo-secret-key',
          signKey: 'extra-signature-key',
          useAuthorization: true
        });

        // æ¨¡æ‹Ÿç­¾åä¿¡æ¯
        setSignatureInfo({
          appId: 'demo-app',
          appSecret: 'demo-secret-key',
          signKey: 'extra-signature-key',
          signatureAlgorithm: 'HMAC-SHA1',
          additionalMd5Signature: true,
          headers: {
            'Signature-AppID': 'demo-app',
            'Signature-Nonce': 'generated-random-nonce',
            'Signature-Timestamp': 'current-timestamp',
            'Signature': 'HMAC-SHA1-hash',
            'Json-RPC-Sign': 'md5-hash'
          }
        });
        setShowSignature(true);
      } catch (error: any) {
        console.error('ç­¾åæ¼”ç¤ºå¤±è´¥:', error);
      }
    };

    return (
      <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '8px', maxWidth: '600px' }}>
        <h3>ç­¾åéªŒè¯æœºåˆ¶æ¼”ç¤º</h3>
        <p>
          å±•ç¤ºJsonRPCçš„ç­¾åéªŒè¯åŠŸèƒ½ï¼ŒåŒ…æ‹¬HMAC-SHA1ç­¾åå’ŒMD5ç­¾åã€‚
        </p>

        <button
          onClick={demonstrateSignature}
          style={{
            padding: '10px 20px',
            background: '#6f42c1',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer',
            marginBottom: '16px'
          }}
        >
          ğŸ” æ¼”ç¤ºç­¾åæœºåˆ¶
        </button>

        {showSignature && signatureInfo && (
          <div style={{
            background: '#f3e5f5',
            padding: '16px',
            borderRadius: '4px',
            border: '1px solid #ce93d8'
          }}>
            <h4>ğŸ” ç­¾åé…ç½®ä¿¡æ¯:</h4>
            <pre style={{ fontSize: '12px', overflow: 'auto' }}>
              {JSON.stringify(signatureInfo, null, 2)}
            </pre>

            <div style={{ marginTop: '16px', fontSize: '14px' }}>
              <h5>ç­¾åæµç¨‹è¯´æ˜:</h5>
              <ol>
                <li>ç”Ÿæˆæ—¶é—´æˆ³å’Œéšæœºnonce</li>
                <li>æ„é€ ç­¾åå­—ç¬¦ä¸²: payload + timestamp + nonce</li>
                <li>ä½¿ç”¨HMAC-SHA1è®¡ç®—ç­¾å</li>
                <li>æ·»åŠ æ‰€æœ‰ç­¾åç›¸å…³è¯·æ±‚å¤´</li>
                <li>å¯é€‰ï¼šé¢å¤–æ·»åŠ MD5ç­¾åéªŒè¯</li>
              </ol>
            </div>
          </div>
        )}
      </div>
    );
  },
  parameters: {
    docs: {
      description: {
        story: 'å±•ç¤ºJsonRPCçš„ç­¾åéªŒè¯æœºåˆ¶ï¼ŒåŒ…æ‹¬HMAC-SHA1å’ŒMD5ç­¾åã€‚'
      }
    }
  }
};