import type { Meta, StoryObj } from '@storybook/react';
import React, { useEffect } from 'react';
import { useJsonRpcRequest, JsonRPC } from './index';
import { setupStorybookTaro, resetStorybookTaro } from './mocks';

// åˆå§‹åŒ–Taro mock
setupStorybookTaro();

const meta: Meta<typeof useJsonRpcRequest> = {
  title: 'Hooks/useJsonRpcRequest',
  component: () => null, // Hook storiesä¸ä½¿ç”¨ç»„ä»¶
  tags: ['autodocs'],
  parameters: {
    layout: 'centered',
    docs: {
      description: {
        component: `
useJsonRpcRequest æ˜¯ä¸€ä¸ªåŸºäºSWRçš„React Hookï¼Œç”¨äºåœ¨Taroåº”ç”¨ä¸­è¿›è¡ŒJSON-RPC 2.0åè®®çš„è¯·æ±‚ã€‚

ä¸»è¦ç‰¹æ€§ï¼š
- ğŸš€ åŸºäºSWRè¿›è¡Œæ•°æ®ç¼“å­˜å’Œé‡æ–°éªŒè¯
- ğŸ” æ”¯æŒJWTè®¤è¯å’Œç­¾åéªŒè¯
- ğŸ“± ä¸“ä¸ºTaroæ¡†æ¶ä¼˜åŒ–
- ğŸ¯ å®Œå…¨TypeScriptæ”¯æŒ
- ğŸ”„ è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œé‡è¯•
        `
      }
    }
  },
};

export default meta;
type Story = StoryObj<typeof meta>;

// åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
export const BasicUsage: Story = {
  render: () => {
    const Component = () => {
      resetStorybookTaro();

      const { data, error, isLoading } = useJsonRpcRequest(
        'user.getProfile',
        { userId: '123' }
      );

      return (
        <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '8px' }}>
          <h3>åŸºç¡€ä½¿ç”¨ç¤ºä¾‹</h3>
          <p>æ–¹æ³•: <code>user.getProfile</code></p>
          <p>å‚æ•°: <code>{`{ userId: '123' }`}</code></p>

          <div style={{ marginTop: '16px' }}>
            {isLoading && <p>â³ åŠ è½½ä¸­...</p>}
            {error && <p style={{ color: 'red' }}>âŒ é”™è¯¯: {error.message}</p>}
            {data && (
              <div style={{ background: '#f5f5f5', padding: '12px', borderRadius: '4px' }}>
                <h4>å“åº”æ•°æ®:</h4>
                <pre style={{ fontSize: '12px', overflow: 'auto' }}>
                  {JSON.stringify(data, null, 2)}
                </pre>
              </div>
            )}
          </div>
        </div>
      );
    };

    return <Component />;
  },
  parameters: {
    docs: {
      description: {
        story: 'æœ€åŸºæœ¬çš„ç”¨æ³•ï¼Œè·å–ç”¨æˆ·èµ„æ–™ä¿¡æ¯ã€‚'
      }
    }
  }
};

// å¸¦é€‰é¡¹çš„ä½¿ç”¨ç¤ºä¾‹
export const WithOptions: Story = {
  render: () => {
    const Component = () => {
      const [logs, setLogs] = React.useState<string[]>([]);

      const addLog = (message: string) => {
        setLogs(prev => [...prev, `${new Date().toLocaleTimeString()}: ${message}`]);
      };

      const { data, error, isLoading, mutate } = useJsonRpcRequest(
        'user.getFriends',
        { userId: '123' },
        {
          swrOptions: {
            revalidateOnFocus: true,
            refreshInterval: 10000, // 10ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆä»…åœ¨Storybookä¸­ç”¨äºæ¼”ç¤ºï¼‰
          },
          onSuccess: (data) => {
            addLog(`âœ… æˆåŠŸè·å– ${data?.length || 0} ä¸ªå¥½å‹`);
          },
          onError: (error) => {
            addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
          },
        }
      );

      const handleRefresh = () => {
        addLog('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ•°æ®');
        mutate();
      };

      return (
        <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '8px' }}>
          <h3>å¸¦é€‰é¡¹çš„ä½¿ç”¨ç¤ºä¾‹</h3>
          <p>æ–¹æ³•: <code>user.getFriends</code></p>
          <p>é…ç½®: è‡ªåŠ¨åˆ·æ–°ã€æˆåŠŸ/é”™è¯¯å›è°ƒ</p>

          <div style={{ marginTop: '16px' }}>
            <button
              onClick={handleRefresh}
              style={{
                padding: '8px 16px',
                background: '#0070f3',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                marginBottom: '16px'
              }}
            >
              ğŸ”„ æ‰‹åŠ¨åˆ·æ–°
            </button>

            {isLoading && <p>â³ åŠ è½½ä¸­...</p>}
            {error && <p style={{ color: 'red' }}>âŒ é”™è¯¯: {error.message}</p>}
            {data && (
              <div style={{ background: '#f5f5f5', padding: '12px', borderRadius: '4px' }}>
                <h4>å¥½å‹åˆ—è¡¨ ({data.length} ä¸ª):</h4>
                <ul>
                  {data.map((friend: any) => (
                    <li key={friend.id}>
                      <strong>{friend.name}</strong> ({friend.email})
                    </li>
                  ))}
                </ul>
              </div>
            )}

            <div style={{ marginTop: '16px', background: '#e8f4fd', padding: '12px', borderRadius: '4px' }}>
              <h4>æ“ä½œæ—¥å¿—:</h4>
              <div style={{ fontSize: '12px', maxHeight: '150px', overflow: 'auto' }}>
                {logs.map((log, index) => (
                  <div key={index}>{log}</div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    return <Component />;
  },
  parameters: {
    docs: {
      description: {
        story: 'å±•ç¤ºå¦‚ä½•ä½¿ç”¨é€‰é¡¹å‚æ•°ï¼ŒåŒ…æ‹¬SWRé…ç½®å’Œç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚'
      }
    }
  }
};

// é”™è¯¯å¤„ç†ç¤ºä¾‹
export const ErrorHandling: Story = {
  render: () => {
    const Component = () => {
      resetStorybookTaro();

      const { data, error, isLoading, isError } = useJsonRpcRequest(
        'nonexistent.method', // ä¸å­˜åœ¨çš„æ–¹æ³•
        { test: 'data' }
      );

      return (
        <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '8px' }}>
          <h3>é”™è¯¯å¤„ç†ç¤ºä¾‹</h3>
          <p>æ–¹æ³•: <code>nonexistent.method</code> (æ•…æ„è°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•)</p>

          <div style={{ marginTop: '16px' }}>
            {isLoading && <p>â³ åŠ è½½ä¸­...</p>}
            {isError && error && (
              <div style={{
                background: '#ffebee',
                color: '#c62828',
                padding: '16px',
                borderRadius: '4px',
                border: '1px solid #ef9a9a'
              }}>
                <h4>âŒ è¯·æ±‚é”™è¯¯</h4>
                <p><strong>é”™è¯¯ä»£ç :</strong> {error.code}</p>
                <p><strong>é”™è¯¯æ¶ˆæ¯:</strong> {error.message}</p>
                {error.data && (
                  <details>
                    <summary>è¯¦ç»†é”™è¯¯ä¿¡æ¯</summary>
                    <pre style={{ fontSize: '12px', marginTop: '8px' }}>
                      {JSON.stringify(error.data, null, 2)}
                    </pre>
                  </details>
                )}
              </div>
            )}
            {data && (
              <div style={{ color: 'green' }}>
                <p>âœ… æ„å¤–æˆåŠŸ: {JSON.stringify(data)}</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    return <Component />;
  },
  parameters: {
    docs: {
      description: {
        story: 'å±•ç¤ºé”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå½“APIè°ƒç”¨å¤±è´¥æ—¶å¦‚ä½•æ•è·å’Œå¤„ç†é”™è¯¯ã€‚'
      }
    }
  }
};

// ç›´æ¥APIè°ƒç”¨ç¤ºä¾‹
export const DirectApiCall: Story = {
  render: () => {
    const Component = () => {
      const [result, setResult] = React.useState<any>(null);
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState<string>('');

      const handleDirectCall = async () => {
        resetStorybookTaro();
        setLoading(true);
        setError('');
        setResult(null);

        try {
          // é¦–å…ˆåˆå§‹åŒ–JsonRPC
          JsonRPC.init({
            baseURL: 'https://mock-api.example.com',
            appId: 'storybook-app',
            appSecret: 'storybook-secret',
            useAuthorization: true
          });

          const response = await JsonRPC.request(
            'system.getStats',
            {},
            {
              withJwt: true,
              headers: {
                'Custom-Header': 'storybook-test'
              }
            }
          );

          setResult(response);
        } catch (err: any) {
          setError(err.message || 'æœªçŸ¥é”™è¯¯');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '8px' }}>
          <h3>ç›´æ¥APIè°ƒç”¨ç¤ºä¾‹</h3>
          <p>ä½¿ç”¨ JsonRPC.request æ–¹æ³•è¿›è¡Œç›´æ¥è°ƒç”¨</p>

          <div style={{ marginTop: '16px' }}>
            <button
              onClick={handleDirectCall}
              disabled={loading}
              style={{
                padding: '8px 16px',
                background: loading ? '#ccc' : '#28a745',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: loading ? 'not-allowed' : 'pointer'
              }}
            >
              {loading ? 'â³ è¯·æ±‚ä¸­...' : 'ğŸš€ å‘é€è¯·æ±‚'}
            </button>

            {error && (
              <div style={{
                background: '#ffebee',
                color: '#c62828',
                padding: '12px',
                borderRadius: '4px',
                marginTop: '16px'
              }}>
                <strong>âŒ é”™è¯¯:</strong> {error}
              </div>
            )}

            {result && (
              <div style={{
                background: '#e8f5e8',
                padding: '12px',
                borderRadius: '4px',
                marginTop: '16px'
              }}>
                <h4>âœ… è¯·æ±‚ç»“æœ:</h4>
                <pre style={{ fontSize: '12px', overflow: 'auto' }}>
                  {JSON.stringify(result, null, 2)}
                </pre>
              </div>
            )}
          </div>
        </div>
      );
    };

    return <Component />;
  },
  parameters: {
    docs: {
      description: {
        story: 'å±•ç¤ºå¦‚ä½•ç›´æ¥ä½¿ç”¨JsonRPCç±»è¿›è¡ŒAPIè°ƒç”¨ï¼Œé€‚åˆåœ¨éç»„ä»¶ç¯å¢ƒä¸­ä½¿ç”¨ã€‚'
      }
    }
  }
};